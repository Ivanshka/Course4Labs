Методичка:
23. ЛР docker.docx

Задание: поставить iRedMail, Docker, в Docker развернуть контейнер с Odoo, настроить Odoo на использование
iRedMail как сервера исходящей почты и создать пользователя Odoo.

Краткая теория для сдачи лабы
	
	Вся архитектура Docker состоит из 3 частей:
		- реестра образом (registry),
		- образов (image),
		- контейнеров (container),
		- и службы Docker (docker daemon).
	
	Контейнер - готовое приложение со своими зависимостями, которое можно тупо запустить и оно будет работать.
	Образ - упакованный-сжатый контейнер.
	Реестр образов - местный Play Market, из которого мы просто берем образы для развертывания на своем Docker.
	Демон Docker - наш сервер, который все-все обслуживает.

	Когда мы запускаем докер-контейнер с каким-то приложением, демон ищет его в локальном репозитории. Нашел -
	запускает в контейнере, не нашел - скачивает с реестра и запускает.

---------------------------------------------------------------------------------------------------------------

Делаем лабу:

0) На приколы с ftp в лабе кладем duke-dick nukem и качаем установщик iRedMail как и раньше через wget) :-)

1) СНАЧАЛА СТАВИМ IREDMAIL по инструкции для первой лабы, КРОМЕ ОДНОГО МОМЕНТА: компонент SOGO мы НЕ СТАВИМ!

2) Затем СТАВИМ DOCKER:
	sudo apt install docker docker.io
	где
		docker - docker-клиент
		docker.io - docker-сервер
		
3) Затем ЗАПУСКАЕМ КОНТЕЙНЕР POSTGRESQL: (https://hub.docker.com/_/odoo)
	sudo docker run -d -e POSTGRES_USER=odoo -e POSTGRES_PASSWORD=odoo -e POSTGRES_DB=postgres --name db postgres:13
	где
		ключ -d запускает контейнер в фоновом режиме, чтобы он не блочил текущий процесс консоли. Хочешь увидеть
			вывод при работе контейнера - запускай без ключа -d

4) ЗАПУСКАЕМ КОНТЕЙНЕР ODOO
	sudo docker run -d -p 8069:8069 --name odoo --link db:db -t odoo
	
5) НАСТРАИВАЕМ ODOO: вводим имя БД, email (я вводил postmaster@laba.com), пароли, язык.

6) В iRedMail добавляем НОВЫЙ ЯЩИК ДЛЯ ОТПРАВКИ ИСХОДЯЩИХ ОТ ODOO ПИСЕМ. (я создал noreply@laba.com)

7) СТАВИМ КАКОЙ-НИБУДЬ БУХГАЛТЕРСКИЙ ПАКЕТ в Odoo, чтобы появились расширенные настройки Odoo.

8) В расширенных настройках СТАВИМ ГАЛОЧКУ ДЛЯ ВКЛЮЧЕНИЯ ПОЛЬЗОВАТЕЛЬСКИХ СЕРВЕРОВ ЭЛЕКТРОННОЙ ПОЧТЫ

8) ДОБАВЛЯЕМ СЕРВЕР ИСХОДЯЩЕЙ ПОЧТЫ
	Заполняем поля: локальный ip (но не внутренняя петля!), порт 587, мыло noreply@laba.com и пароль от этого же мыла
	Делаем тест, он упадет. Идем в...
		sudo nano /opt/iredapd/settings.py
	...и в самом конце дописываем разрешение на подключение с помощью нашего ящика:
		ALLOWED_LOGIN_MISMATCH_SENDERS = ['noreply@laba.com']
	После этого перезагружаем iredapd:
		sudo systemctl restart iredapd
	Снова делаем тест, должен сработать.

9) ПРИГЛАШАЕМ нового ПОЛЬЗОВАТЕЛЯ в Odoo
	1) Создаем новый ящик
		odoo@laba.com
	2.1) Создаем нового пользователя Odoo с почтой odoo@laba.com и пытаемся отправить пригласительное письмо. Скорее всего не выйдет и он упадет с исключением, у которого примерно такой шаблон:
		<мыло> (550, <другоеСтранноеМыло>), sender address rejected: user unknown
	2.2) Исправляем исключение:
		Вариант 1, который по идее должен был у меня сработать (так сказал google), но не сработал.
			Идем в...
				sudo nano /etc/postfix/main.cf
			...и комментируем строчку...
				#smtpd_reject_unlisted_sender= yes
			после чего рестартим почтовый сервер postfix:
				sudo postfix reload
		Вариант 2, который найден методом "авось прокатит"
			Снова пытаемся отправить пригласительное письмо и выбиваем исключение
			Смотрим то самое <другоеСтранноеМыло>. У меня оно было bounce@laba.com.
			Понимаем, что мы такого мыла не создавали
			Создаем такое мыло в качестве заглушки
			Отправляем письмо
	3) Топаем в ящик odoo@laba.com и видим там прилетевшее письмо от мыла, которое указывали при первоначальной настройке Odoo. Почему именно от него, а не от <другогоСтранногоМыла>, не известно, но и хер с ним.
	4) Принимаем приглащение из письма и заканчиваем регистрацию нового пользователя, введя пароль для него.

Источники:
https://hub.docker.com/_/odoo
https://serverfault.com/questions/591963/postfixerror-sender-address-rejected-user-unknown-in-virtual-mailbox-table
https://docs.iredmail.org/errors.html#recipient-address-rejected-sender-is-not-same-as-smtp-authenticate-username
https://forum.iredmail.org/topic11192-smtp-error.html
